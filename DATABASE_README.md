# База данных SellKit

## Обзор

В проекте SellKit используется **SQLite** база данных для хранения пользовательских данных, анализов товаров и финансовых отчетов.

## Почему SQLite?

- **Простота**: Не требует отдельного сервера базы данных
- **Надежность**: Файловая база данных, легко бэкапить
- **Быстрота**: Отлично подходит для небольших и средних проектов
- **Бесплатность**: Не требует лицензий
- **Портативность**: База данных - это один файл

## Структура базы данных

### Таблица `users`

Хранит информацию о пользователях Telegram:

- `id` - уникальный идентификатор пользователя
- `telegramId` - ID пользователя в Telegram
- `username` - имя пользователя в Telegram
- `firstName` - имя пользователя
- `lastName` - фамилия пользователя
- `avatarUrl` - URL аватара пользователя
- `createdAt` - дата создания записи
- `updatedAt` - дата последнего обновления

### Таблица `analyses`

Хранит результаты анализа товаров:

- `id` - уникальный идентификатор анализа
- `userId` - ID пользователя (связь с таблицей users)
- `title` - название анализа
- `description` - описание товара
- `category` - категория товара
- `recommendedPrice` - рекомендуемая цена
- `priceRangeMin` - минимальная цена в диапазоне
- `priceRangeMax` - максимальная цена в диапазоне
- `competition` - уровень конкуренции (1-10)
- `recommendations` - рекомендации по продаже
- `avgRating` - средний рейтинг товара
- `imageUrl` - URL изображения товара
- `createdAt` - дата создания анализа
- `updatedAt` - дата последнего обновления

### Таблица `reports`

Хранит обработанные финансовые отчеты:

- `id` - уникальный идентификатор отчета
- `userId` - ID пользователя (связь с таблицей users)
- `title` - название отчета
- `fileName` - имя файла отчета
- `filePath` - путь к файлу на сервере
- `fileSize` - размер файла в байтах
- `processedData` - обработанные данные в JSON формате
- `summary` - краткое описание отчета
- `createdAt` - дата создания отчета
- `updatedAt` - дата последнего обновления

## Расположение файлов

- **База данных**: `data/database.sqlite`
- **Отчеты**: `data/reports/` (папка с обработанными Excel файлами)

## API Endpoints

### Пользователи

- `POST /api/profile/user` - создать или обновить пользователя
- `GET /api/profile/user/:telegramId/stats` - получить статистику пользователя

### Анализы

- `POST /api/profile/analysis` - сохранить анализ товара
- `GET /api/profile/user/:telegramId/analyses` - получить анализы пользователя
- `GET /api/profile/analysis/:id` - получить конкретный анализ

### Отчеты

- `POST /api/profile/report` - сохранить отчет
- `GET /api/profile/user/:telegramId/reports` - получить отчеты пользователя
- `GET /api/profile/report/:id` - получить конкретный отчет

## Автоматическое сохранение

### Анализы товаров

Анализы автоматически сохраняются в базу данных при:

- Успешном анализе изображения товара
- Авторизации пользователя в Telegram
- Передаче параметра `saveAnalysis=true` в запросе

### Финансовые отчеты

Отчеты автоматически сохраняются при:

- Успешной обработке Excel файла
- Авторизации пользователя в Telegram
- Передаче параметра `saveReport=true` в запросе

## Резервное копирование

Для создания резервной копии базы данных:

```bash
# Копируем файл базы данных
cp data/database.sqlite backup/database_backup_$(date +%Y%m%d_%H%M%S).sqlite

# Копируем папку с отчетами
cp -r data/reports backup/reports_backup_$(date +%Y%m%d_%H%M%S)/
```

## Восстановление из резервной копии

```bash
# Восстанавливаем базу данных
cp backup/database_backup_YYYYMMDD_HHMMSS.sqlite data/database.sqlite

# Восстанавливаем отчеты
cp -r backup/reports_backup_YYYYMMDD_HHMMSS/ data/reports/
```

## Мониторинг и обслуживание

### Проверка размера базы данных

```bash
ls -lh data/database.sqlite
```

### Очистка старых данных (опционально)

Можно добавить автоматическую очистку данных старше определенного периода:

```sql
-- Удалить анализы старше 1 года
DELETE FROM analyses WHERE createdAt < datetime('now', '-1 year');

-- Удалить отчеты старше 1 года
DELETE FROM reports WHERE createdAt < datetime('now', '-1 year');
```

## Безопасность

- База данных SQLite защищена на уровне файловой системы
- Все пользовательские данные привязаны к Telegram ID
- Файлы отчетов хранятся в отдельной папке
- Регулярно создавайте резервные копии

## Производительность

SQLite отлично подходит для:

- До 1000 одновременных пользователей
- База данных до 1 ГБ
- Простые запросы и операции

Для больших нагрузок рекомендуется переход на PostgreSQL или MySQL.

## Устранение неполадок

### База данных заблокирована

```bash
# Проверяем процессы, использующие базу данных
lsof data/database.sqlite

# Перезапускаем сервер
npm restart
```

### Ошибка "database is locked"

- Убедитесь, что нет других процессов, использующих базу данных
- Проверьте права доступа к файлу базы данных
- Перезапустите сервер приложения

### Файл базы данных поврежден

```bash
# Проверяем целостность базы данных
sqlite3 data/database.sqlite "PRAGMA integrity_check;"

# Восстанавливаем из резервной копии
cp backup/database_backup_latest.sqlite data/database.sqlite
```
